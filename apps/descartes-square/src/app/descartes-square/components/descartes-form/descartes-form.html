@let delay = 400;
@let position = "above";
@let user = currentUser();

<form [formGroup]="form">
  <div class="input-container title-container">
    <label class="open-sans-regular" for="title">Title</label>
    <input id="title" type="text" formControlName="title" />
    @let titleControl = form.controls.title;

    <!-- Error Tooltip -->
    @if (titleControl.invalid) {
      <div class="error-tooltip error-visible">
        @switch (true) {
          @case (titleControl.hasError("required")) {
            This field is required.
          }
          @case (titleControl.hasError("unclearTitle")) {
            Your decision title is unclear. Please restate it as a specific
            decision, e.g., 'Should I move to another city?' or 'Should I start
            my own business?'
          }
        }
      </div>
    }
  </div>

  <ng-container
    *ngTemplateOutlet="
      controlTemplate;
      context: {
        key: descartesQuestionsIds.Q1,
      }
    "
  >
  </ng-container>

  <ng-container
    *ngTemplateOutlet="
      controlTemplate;
      context: {
        key: descartesQuestionsIds.Q2,
      }
    "
  >
  </ng-container>

  <ng-container
    *ngTemplateOutlet="
      controlTemplate;
      context: {
        key: descartesQuestionsIds.Q3,
      }
    "
  >
  </ng-container>

  <ng-container
    *ngTemplateOutlet="
      controlTemplate;
      context: {
        key: descartesQuestionsIds.Q4,
      }
    "
  >
  </ng-container>

  <label class="open-sans-regular" for="conclusion">Conclusion</label>
  <input type="text" formControlName="conclusion" />
</form>

<div class="controls">
  <button class="controls__cancel" matButton="tonal" (click)="cancelForm()">
    Cancel
  </button>

  <button
    class="controls__clear"
    matButton="outlined"
    [disabled]="form.pristine"
    (click)="clearForm()"
  >
    Clear
  </button>

  <button
    class="controls__save"
    matButton="outlined"
    [disabled]="form.pristine"
    (click)="saveForm()"
  >
    {{ id() ? "Update" : "Save" }}
  </button>
</div>

<ng-template #controlTemplate let-key="key;">
  <ng-container [formGroup]="form">
    @let formArray = getFormArrayControls(key);
    <p class="open-sans-regular">{{ descartesQuestions.get(key) }}</p>

    <ng-container [formArrayName]="key">
      <ul>
        @for (control of formArray; let index = $index; track control) {
          @if (formEditTracker.get(key)?.index === index) {
            <li class="arg-list input-container">
              <textarea
                appAutoFocus
                cdkTextareaAutosize
                autocomplete="off"
                class="roboto-regular"
                placeholder="Type your text here..."
                [class.loading]="isLoading()"
                [formControl]="control"
                [id]="key"
                (blur)="onBlur($event, key, index)"
              ></textarea>

              <!-- Error Tooltip -->
              @if (control.invalid && (control.dirty || control.touched)) {
                <div class="error-tooltip error-visible">
                  @switch (true) {
                    @case (control.hasError("required")) {
                      This field is required.
                    }

                    @case (control.hasError("minlength")) {
                      The minimum length of text should be
                      {{ control?.errors?.["minlength"]?.requiredLength }}.
                    }

                    @case (control.hasError("maxlength")) {
                      The maximum length of text should not exceed
                      {{ control?.errors?.["maxlength"]?.requiredLength }}
                      symbols..
                    }
                  }
                </div>
              }

              <button
                class="btn cancel-arg"
                [attr.data-index]="index"
                [matTooltip]="'Cancel'"
                [matTooltipPosition]="position"
                [matTooltipShowDelay]="delay"
                (click)="cancelArgument(index, key)"
              >
                &#x2715;
              </button>
              <button
                class="btn save-arg"
                [attr.data-index]="index"
                [matTooltip]="'Save'"
                [matTooltipPosition]="position"
                [matTooltipShowDelay]="delay"
                [disabled]="isLoading()"
                (click)="saveArgument(key)"
              >
                &#x2713;
              </button>
            </li>
          } @else {
            <li class="roboto-regular arg-list">
              <p>{{ control.value }}</p>
              <button
                class="btn remove-arg"
                [matTooltip]="'Remove'"
                [matTooltipPosition]="position"
                [matTooltipShowDelay]="delay"
                (click)="deleteArgument(index, key)"
              >
                &#x2715;
              </button>

              <button
                class="btn edit-arg"
                [matTooltip]="'Edit'"
                [matTooltipPosition]="position"
                [matTooltipShowDelay]="delay"
                [disabled]="isLoading()"
                (click)="editArgument(index, key)"
              >
                &#9998;
              </button>
            </li>
          }
        }

        @if (!formEditTracker.get(key)?.isCreating) {
          <li class="roboto-regular add-btn-container">
            <button
              class="btn add-arg"
              [matTooltip]="'Add Argument'"
              [matTooltipPosition]="position"
              [matTooltipShowDelay]="delay"
              (click)="addArgument(key)"
            >
              <span class="plus">&#65291;</span>
            </button>

            @if (user) {
              @let isDisabled = !form.controls.title.value;
              <button
                class="btn add-ai"
                [matTooltip]="isDisabled ? 'Add Title' : 'AI Suggestion'"
                [matTooltipPosition]="position"
                [matTooltipShowDelay]="delay"
                [disabled]="isDisabled"
                (click)="addAISuggestion(key)"
              >
                <span class="ai-icon">&#xFCC;</span>
              </button>
            }
          </li>
        }
      </ul>
    </ng-container>
  </ng-container>
</ng-template>
